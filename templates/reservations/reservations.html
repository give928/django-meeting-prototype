{% extends "layout/base.html" %}
{% load static %}
{% block extra_styles %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/reservations.css' %}">
{% endblock %}
{% load humanize %}
{% block content %}
    <h1>ÏòàÏïΩ</h1>
    <hr class="my-4">
    <div class="m-0 border-0">
        <nav>
            <div class="mb-3">
                <div class="nav nav-tabs flex-grow-1" id="nav-tab" role="tablist">
                    <button class="nav-link{% if not request.GET.page %} active{% endif %}" id="nav-timeline-tab" data-bs-toggle="tab" data-bs-target="#nav-timeline" type="button"
                            role="tab" aria-controls="nav-timeline" aria-selected="true" onclick="initializeParameters('timeline')">Timeline
                    </button>
                    <button class="nav-link{% if request.GET.page %} active{% endif %}" id="nav-list-tab" data-bs-toggle="tab" data-bs-target="#nav-list" type="button" role="tab"
                            aria-controls="nav-list" aria-selected="false" tabindex="-1" onclick="initializeParameters('list')">List
                    </button>
                </div>
            </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade{% if not request.GET.page %} active show{% endif %}" id="nav-timeline" role="tabpanel" aria-labelledby="nav-timeline-tab">
                {% include "reservations/_filter_form.html" with action_url=request.path list_mode=False %}
                <hr/>
                {% for room in rooms %}
                    <div class="card mb-3">
                        <div class="card-header">
                            <input type="hidden" id="id_room{{ room.id }}" value="{{ room.id }}"/>
                            <p class="mb-1">{{ room.name }}{% if room.has_monitor %}&nbsp;üñ•{% endif %}{% if room.has_microphone %}&nbsp;üé§{% endif %}</p>
                        </div>
                        <div class="card-body">
                            <div class="border reservation-time">
                                <div id="timeline{{ room.id }}" class="top-0 start-0 w-100 h-100 reservation-timeline"></div>
                                <div id="time-ruler{{ room.id }}" class="bottom-0 start-0 w-100 d-flex"></div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="tab-pane fade{% if request.GET.page %} active show{% endif %}" id="nav-list" role="tabpanel" aria-labelledby="nav-list-tab">
                {% include "reservations/_filter_form.html" with action_url=request.path list_mode=True %}
                <hr/>
                <div class="accordion" id="reservations">
                    {% if page_reservations %}
                        {% for reservation in page_reservations %}
                            <div class="accordion-item">
                                <h4 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ reservation.pk }}"
                                            aria-expanded="false"
                                            aria-controls="collapse{{ reservation.pk }}">
                                        <div class="w-100 d-flex justify-content-between flex-wrap">
                                            <div>
                                                [{{ reservation.room.name }}{% if reservation.room.has_monitor %}
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-display" viewBox="0 0 16 16">
                                                    <path d="M0 4s0-2 2-2h12s2 0 2 2v6s0 2-2 2h-4q0 1 .25 1.5H11a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1h.75Q6 13 6 12H2s-2 0-2-2zm1.398-.855a.76.76 0 0 0-.254.302A1.5 1.5 0 0 0 1 4.01V10c0 .325.078.502.145.602q.105.156.302.254a1.5 1.5 0 0 0 .538.143L2.01 11H14c.325 0 .502-.078.602-.145a.76.76 0 0 0 .254-.302 1.5 1.5 0 0 0 .143-.538L15 9.99V4c0-.325-.078-.502-.145-.602a.76.76 0 0 0-.302-.254A1.5 1.5 0 0 0 13.99 3H2c-.325 0-.502.078-.602.145"></path>
                                                </svg>
                                            {% endif %}{% if reservation.room.has_microphone %}
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic" viewBox="0 0 16 16">
                                                    <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5"></path>
                                                    <path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3"></path>
                                                </svg>{% endif %}]&nbsp;{{ reservation.title }}
                                            </div>
                                            <div class="pe-2">[{{ reservation.group_name }}]{{ reservation.created_user }}&nbsp;[{{ reservation.start_datetime|date:'Y-m-d H:i' }}
                                                ~ {{ reservation.end_datetime|date:'Y-m-d H:i' }}]
                                            </div>
                                        </div>
                                    </button>
                                </h4>
                                <div id="collapse{{ reservation.pk }}" class="accordion-collapse collapse" data-bs-parent="#reservations">
                                    <div class="accordion-body">
                                        <div data-bs-spy="scroll" data-bs-offset="0" class="position-relative overflow-auto scrollspy-reservation" tabindex="0">
                                            {% if reservation.attendees_names != None %}
                                                <div class="mb-3">
                                                    <div class="reservation-content">
                                                        Ï¢åÏÑù:&nbsp;{{ reservation.room.seat_count|intcomma }}&nbsp;ÏµúÎåÄ:&nbsp;{{ reservation.room.capacity_count|intcomma }}</div>
                                                    <div class="reservation-content">Ï∞∏ÏÑù:&nbsp;{{ reservation.attendees_count|intcomma }}</div>
                                                    <div class="reservation-content">{{ reservation.attendees_names }}</div>
                                                </div>
                                            {% endif %}
                                            {% if reservation.description != None %}
                                                <pre>{{ reservation.description }}</pre>
                                            {% endif %}
                                        </div>
                                        <div class="btn-group mt-3">
                                            <a class="btn btn-sm btn-outline-secondary" href="{% url 'reservation' pk=reservation.pk %}?{{ request.GET.urlencode }}">
                                                {% if reservation.readonly == False %}
                                                    Edit{% else %}
                                                    View{% endif %}</a>
                                            {% if reservation.meeting.id %}
                                                <a class="btn btn-sm btn-outline-success" href="{% url 'meeting' pk=reservation.meeting.id %}">ÌöåÏùòÎ≥¥Í∏∞</a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="nodata">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-database-fill-slash" viewBox="0 0 16 16">
                                <path d="M13.879 10.414a2.501 2.501 0 0 0-3.465 3.465zm.707.707-3.465 3.465a2.501 2.501 0 0 0 3.465-3.465m-4.56-1.096a3.5 3.5 0 1 1 4.949 4.95 3.5 3.5 0 0 1-4.95-4.95ZM8 1c-1.573 0-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4s.875 1.755 1.904 2.223C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777C13.125 5.755 14 5.007 14 4s-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1"></path>
                                <path d="M2 7v-.839c.457.432 1.004.751 1.49.972C4.722 7.693 6.318 8 8 8s3.278-.307 4.51-.867c.486-.22 1.033-.54 1.49-.972V7c0 .424-.155.802-.411 1.133a4.51 4.51 0 0 0-4.815 1.843A12 12 0 0 1 8 10c-1.573 0-3.022-.289-4.096-.777C2.875 8.755 2 8.007 2 7m6.257 3.998L8 11c-1.682 0-3.278-.307-4.51-.867-.486-.22-1.033-.54-1.49-.972V10c0 1.007.875 1.755 1.904 2.223C4.978 12.711 6.427 13 8 13h.027a4.55 4.55 0 0 1 .23-2.002m-.002 3L8 14c-1.682 0-3.278-.307-4.51-.867-.486-.22-1.033-.54-1.49-.972V13c0 1.007.875 1.755 1.904 2.223C4.978 15.711 6.427 16 8 16c.536 0 1.058-.034 1.555-.097a4.5 4.5 0 0 1-1.3-1.905"></path>
                            </svg>
                            Í≤ÄÏÉâÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                        </div>
                    {% endif %}
                </div>
                {% load querystring_tags %}
                {% querystring_without_page request '&' as add_querystring %}
                {% include "components/pagination.html" with pagination=page_reservations add_querystring=add_querystring %}
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_scripts %}
    <script type="text/javascript" src="{% static "js/reservations.js" %}"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            {% for room in rooms %}
                new reservation({
                    timelineContainer: document.getElementById('timeline{{ room.id }}'),
                    timeRuler: document.getElementById('time-ruler{{ room.id }}'),
                    room: document.getElementById('id_room{{ room.id }}'),
                    startDateTime: document.getElementsByName('date')[0],
                    endDateTime: document.getElementsByName('date')[0],
                    querystring: '{{ request.GET.urlencode }}'
                });
            {% endfor %}
        });

        function initializeParameters(type) {
            const url = new URL(window.location.href);
            if (type === 'timeline') {
                deleteParameter(url, 'page');
                deleteParameter(url, 'start_date');
                deleteParameter(url, 'end_date');
                deleteParameter(url, 'user');
                deleteParameter(url, 'attendee');
                url.searchParams.set('date', document.getElementById('date').value);
                window.history.replaceState({}, '', url);
            } else if (type === 'list') {
                deleteParameter(url, 'date');
                url.searchParams.set('page', `{{ request.GET.page }}`);
                url.searchParams.set('start_date', document.getElementById('start_date').value);
                url.searchParams.set('end_date', document.getElementById('end_date').value);
                url.searchParams.set('user', document.getElementById('user').value);
                url.searchParams.set('attendee', document.getElementById('attendee').value);
                window.history.replaceState({}, '', url);
            }
        }

        function deleteParameter(url, name) {
            if (url.searchParams.has(name)) {
                url.searchParams.delete(name);
            }
        }
    </script>
{% endblock %}