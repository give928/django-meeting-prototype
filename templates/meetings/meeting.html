{% extends "layout/base.html" %}
{% load static %}
{% block extra_styles %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/meetings.css' %}">
{% endblock %}
{% load django_bootstrap5 %}
{% load time_tags %}
{% block content %}
    <h1>íšŒì˜</h1>
    <hr class="my-4">
    <div class="row">
        <form class="needs-validation row" id="meeting-form" method="POST" novalidate>
            {% csrf_token %}
            <input type="hidden" id="_method" name="_method" value="{{ form.instance.pk|yesno:'PUT,' }}"/>
            {% if not form.readonly and form.instance.reservation_id != None %}
                <div class="d-flex col-md-1 mb-3 align-items-center">
                    {% if form.instance.reservation_id %}
                        <a href="{% url 'meeting' pk=form.instance.reservation_id %}" class="btn btn-success">ì˜ˆì•½ë³´ê¸°</a>
                    {% endif %}
                </div>
            {% endif %}
            {% bootstrap_field form.is_open layout='floating' wrapper_class='col-md-1 mb-3 d-flex align-items-center form-switch' %}
            {% bootstrap_field form.start_datetime layout='floating' wrapper_class='col-md-3 mb-3 form-floating' %}
            {% bootstrap_field form.end_datetime layout='floating' wrapper_class='col-md-3 mb-3 form-floating' %}
            {% bootstrap_field form.title layout='floating' %}
            <div class="mb-3">
                <div class="card">
                    <div class="card-header">ê¸°ë¡</div>
                    <div class="card-body">
                        <div class="accordion{% if not recordings %} d-none{% endif %}" id="accordionRecordings">
                            {% if recordings %}
                                {% for recording in recordings %}
                                    <div class="accordion-item" id="recording-{{ recording.id }}">
                                        <h4 class="accordion-header">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                                    data-bs-target="#collapse-recording-{{ recording.id }}"
                                                    aria-expanded="false"
                                                    aria-controls="collapse-recording-{{ recording.id }}">{{ forloop.counter }}. {{ recording.play_millisecond|ms_to_hms }}</button>
                                        </h4>
                                        <div id="collapse-recording-{{ recording.id }}" class="accordion-collapse collapse">
                                            <div class="accordion-body">
                                                <div class="d-flex align-items-center">
                                                    <audio data-recording_id="{{ recording.pk }}" controls
                                                           src="{% url 'recording_download' form.instance.pk recording.pk %}?mode=play" class="flex-grow-1"
                                                           preload="metadata"></audio>
                                                    <a href="{% url 'recording_download' form.instance.pk recording.pk %}" download class="btn btn-outline-secondary btn-sm ms-3">ë‹¤ìš´ë¡œë“œ</a>
                                                    {% if recording.latest_summarization.task_status_code == 'completed' %}
                                                        <button class="btn btn-primary btn-sm ms-2 viewTranscriptButton" data-recording_id="{{ recording.id }}"
                                                                data-speech_recognition_id="{{ recording.latest_summarization_id }}"
                                                                data-summarization_id="{{ recording.latest_summarization_id }}">
                                                            ì „ì‚¬ ë³´ê¸°
                                                        </button>
                                                    {% elif recording.latest_summarization.task_status_code or recording.latest_speech_recognition.task_status_code == 'completed' %}
                                                        <button class="btn btn-primary btn-sm ms-2 pollingTranscriptButton disabled" data-recording_id="{{ recording.id }}"
                                                                data-speech_recognition_id="{{ recording.latest_summarization_id }}">
                                                            êµì •Â·ìš”ì•½ ì²˜ë¦¬ ì¤‘
                                                        </button>
                                                    {% elif recording.latest_speech_recognition.task_status_code %}
                                                        <button class="btn btn-primary btn-sm ms-2 pollingTranscriptButton disabled" data-recording_id="{{ recording.id }}"
                                                                data-speech_recognition_id="{{ recording.latest_summarization_id }}">
                                                            ì „ì‚¬ ì²˜ë¦¬ ì¤‘
                                                        </button>
                                                    {% else %}
                                                        <button class="btn btn-warning btn-sm ms-2 requestTranscriptButton" data-recording_id="{{ recording.id }}">ì „ì‚¬ ì²˜ë¦¬</button>
                                                    {% endif %}
                                                </div>
                                                <div class="transcript-container rounded d-none" id="transcript-{{ recording.id }}">
                                                    <div data-bs-spy="scroll" data-bs-offset="0" class="position-relative overflow-auto scrollspy-transcript"
                                                         id="transcript-content-{{ recording.id }}" tabindex="0">
                                                        <div class="spinner-border text-primary d-none" id="spinner-{{ recording.id }}"></div>
                                                        <span class="ms-3" id="transcript-status-message-{{ recording.id }}"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        {% if not recordings %}
                            <div class="nodata p-0">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-database-fill-slash" viewBox="0 0 16 16">
                                    <path d="M13.879 10.414a2.501 2.501 0 0 0-3.465 3.465zm.707.707-3.465 3.465a2.501 2.501 0 0 0 3.465-3.465m-4.56-1.096a3.5 3.5 0 1 1 4.949 4.95 3.5 3.5 0 0 1-4.95-4.95ZM8 1c-1.573 0-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4s.875 1.755 1.904 2.223C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777C13.125 5.755 14 5.007 14 4s-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1"></path>
                                    <path d="M2 7v-.839c.457.432 1.004.751 1.49.972C4.722 7.693 6.318 8 8 8s3.278-.307 4.51-.867c.486-.22 1.033-.54 1.49-.972V7c0 .424-.155.802-.411 1.133a4.51 4.51 0 0 0-4.815 1.843A12 12 0 0 1 8 10c-1.573 0-3.022-.289-4.096-.777C2.875 8.755 2 8.007 2 7m6.257 3.998L8 11c-1.682 0-3.278-.307-4.51-.867-.486-.22-1.033-.54-1.49-.972V10c0 1.007.875 1.755 1.904 2.223C4.978 12.711 6.427 13 8 13h.027a4.55 4.55 0 0 1 .23-2.002m-.002 3L8 14c-1.682 0-3.278-.307-4.51-.867-.486-.22-1.033-.54-1.49-.972V13c0 1.007.875 1.755 1.904 2.223C4.978 15.711 6.427 16 8 16c.536 0 1.058-.034 1.555-.097a4.5 4.5 0 0 1-1.3-1.905"></path>
                                </svg>
                                ë“±ë¡ëœ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% if not form.readonly %}
                <div class="mb-3">
                    <div class="card">
                        <div class="card-header">ë…¹ìŒ</div>
                        <div class="card-body">
                            <div id="recordingPlay"></div>
                            <div class="d-flex align-items-center gap-2">
                                <button id="startRecodingButton" class="btn btn-danger">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-record-circle-fill" viewBox="0 0 16 16">
                                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-8 3a3 3 0 1 0 0-6 3 3 0 0 0 0 6"></path>
                                    </svg>
                                    ë…¹ìŒ ì‹œì‘
                                </button>
                                <button id="stopRecodingButton" class="btn btn-secondary d-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stop-fill" viewBox="0 0 16 16">
                                        <path d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5"></path>
                                    </svg>
                                    ë…¹ìŒ ì¢…ë£Œ
                                </button>
                                <button id="uploadButton" class="btn btn-primary d-none">ì—…ë¡œë“œ</button>
                                <div id="recordingStatus" class="text-success visually-hidden ms-3">â— ë…¹ìŒ ì¤‘</div>
                                <div id="recordingTimer" class="ms-3 fw-bold">00:00:00</div>
                                <canvas id="recordingVolume" class="ms-3" width="300" height="40" style="border-radius:4px;background:#f8f9fa;"></canvas>
                            </div>
                            <div class="mt-3 pt-3 border-top d-flex align-items-center gap-3" id="fileUploadContainer">
                                <label for="audioFile" class="form-label mb-0 fw-bold text-nowrap">ë³„ë„ ë…¹ìŒ íŒŒì¼ ì—…ë¡œë“œ</label>
                                <input class="form-control flex-grow-1" type="file" id="audioFile" accept="audio/*" multiple="false"/>
                                <button id="uploadFileButton" class="btn btn-primary flex-shrink-0 text-nowrap" disabled="">ì—…ë¡œë“œ</button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
            <div class="accordion mb-3" id="accordionAttendees">
                <div class="accordion-item">
                    <h4 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-attendee" aria-expanded="false"
                                aria-controls="collapse-attendee">ì°¸ì„ì
                        </button>
                    </h4>
                    <div id="collapse-attendee" class="accordion-collapse collapse" data-bs-parent="#accordionAttendees">
                        <div class="accordion-body">
                            {% include "components/departments.html" with hierarchical_departments=departments visible_checkboxes=True checked_users=attendees user_input_name="attendees" readonly=form.readonly auto_initialize=False %}
                        </div>
                    </div>
                </div>
            </div>
            {% bootstrap_field form.memo layout='floating' wrapper_class='mb-0' %}
            <hr class="my-4">
            <div class="btn-group w-100 align-items-center justify-content-between flex-wrap me-0 mb-3">
                <div>
                    {% if not form.readonly and form.instance.pk != None %}
                        {% bootstrap_button button_type="button" button_class="btn-danger" id="deleteButton" content="ì‚­ì œ" %}
                    {% endif %}
                    {% if not form.readonly %}
                        {% bootstrap_button button_type="reset" button_class="btn-success" content="ì´ˆê¸°í™”" %}
                    {% endif %}
                </div>
                <div>
                    {% if not form.readonly %}
                        {% bootstrap_button button_type="submit" button_class="btn-primary" content="ì €ì¥" %}
                    {% endif %}
                    <a class="btn btn-secondary" href="{% url 'meetings' %}?{{ request.GET.urlencode }}">ëª©ë¡</a>
                </div>
            </div>
        </form>
    </div>
{% endblock %}
{% block extra_scripts %}
    <script type="text/javascript" src="{% static "js/marked/marked.min.js" %}"></script>
    <script type="text/javascript" src="{% static "js/meetings.js" %}"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            marked.use({
                gfm: true,
            });

            const deleteButton = document.getElementById('deleteButton');
            if (deleteButton) {
                deleteButton.addEventListener('click', async event => {
                    event.preventDefault();

                    const confirmed = await confirmModal.show({
                        message: 'ì‚­ì œí• ê¹Œìš”?',
                        okText: 'ì‚­ì œ',
                        okClass: 'btn-danger'
                    });
                    if (confirmed) {
                        document.querySelector('#meeting-form input[name="_method"]').value = 'DELETE';
                        document.querySelector('#meeting-form').submit();
                    }
                });
            }

            const t = new tree({
                readonly: {% if readonly %}true{% else %}false{% endif %},
                wrapperElement: document.querySelector('#hierarchical-departments'),
                toggleButtonSelector: 'a.tree-toggle-button',
                expandButtonSelector: 'a#tree-expand-button',
                collapseButtonSelector: 'a#tree-collapse-button',
                internalCheckboxSelector: 'input.department[type="checkbox"]',
                leafCheckboxSelector: 'input.user[type="checkbox"]',
                parentAttribute: 'data-group-id'
            });

            new meetings({
                meetingId: {% if form.instance.pk == None %}null{% else %}'{{ form.instance.pk }}'{% endif %},
                meetingForm: document.getElementById('meeting-form'),
                startRecodingButton: document.getElementById('startRecodingButton'),
                stopRecodingButton: document.getElementById('stopRecodingButton'),
                uploadButton: document.getElementById('uploadButton'),
                recordingTimer: document.getElementById('recordingTimer'),
                recordingVolume: document.getElementById('recordingVolume'),
                recordingStatus: document.getElementById('recordingStatus'),
                recordingPlay: document.getElementById('recordingPlay'),
                recordings: document.getElementById('accordionRecordings'),
                viewTranscriptButtonClassName: 'viewTranscriptButton',
                pollingTranscriptButtonClassName: 'pollingTranscriptButton',
                requestTranscriptButtonClassName: 'requestTranscriptButton'
            });

            FormValidators.add(document.getElementById('meeting-form'), (form) => {
                const attendees = t.getCheckedLeaf();
                if (attendees === null || attendees.length === 0) {
                    toast('ğŸš« ì°¸ì„ìë¥¼ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    BootstrapAccordionUtils.focus(document.getElementById('collapse-attendee'));
                    return false;
                }
                return true;
            });
        });
    </script>
{% endblock %}